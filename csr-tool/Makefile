SVNROOT=svn+ssh://kreesema@masvn/svn

.NOTPARALLEL:
.PHONY: help
.DEFAULT: help
.SILENT: help
help:
	echo ""
	echo "Tool to generate files from YAML CSR files"
	echo ""
	echo "Targets:"
	echo "    fetch:        Fetch YAML from tiger01:work/csr/*.yaml"
	echo "    generate:     Read in the YAML and generate all output files"
	echo "    copy-html:    Copy html files to /var/www/csr-html"
	echo "    copy-headers: Copy all generated files into their correct locations"
	echo "    copy: Do both copy-html and copy-headers"
	echo "    all:          Do fetch, generate, and copy"
	echo "    clean:        Clean generated and downloaded files"
	echo ""
	echo "Note:"
	echo "  * The YAML files fetched are generated by Makefile.csr-cluster"
	echo "    run on the MA cluster (tiger01). This uses csr3 to simplify"
	echo "    the YAML before this file uses it."
	echo "  * All CSRs in a chip are in one big YAML file."
	echo "  * YAML files are named by chip and pass. See the yaml dir after fetch."
	echo "  * chip_list.py has all the chip and pass info."
	echo ""

.PHONY: all
all: fetch generate copy

.PHONY: fetch
fetch: clean
	rm -rf yaml
	mkdir yaml
	scp -C tiger01:work/csr/*.yaml yaml/
	# Fixups for CN70XX
	sed -i "s/SMI\\([0-9(]\\)/SMI_\\1/g" yaml/o70*.yaml
	# Fixups for CN73XX
	sed -i "s/CIU3_/CIU_/g" yaml/o73*.yaml
	# Fixups for CNF75XX
	sed -i "s/CIU3_/CIU_/g" yaml/o75*.yaml
	# Fixups for CN78XX
	sed -i "s/CIU3_/CIU_/g" yaml/o78*.yaml

.PHONY: generate
generate:
	rm -rf html output
	mkdir html output output/octeon output/thunder
	cp sorttable.js html/
	cp csr.css html/
	./csr-tool.py

.PHONY: copy-headers
copy-headers:
	rm -f mv ../libbdk-arch/bdk-csrs*.h
	mv output/thunder/bdk-csrs*.h ../libbdk-arch/
	mv output/thunder/bdk-csrs.c ../libbdk-arch/

.PHONY: copy-html
copy-html:
	rm -rf /var/www/csr-html
	mv html /var/www/csr-html
	chmod -R o+r /var/www/csr-html

.PHONY: copy
copy: copy-headers copy-html

.PHONY: clean
clean:
	rm -rf output html yaml *.pickle *.pyc

