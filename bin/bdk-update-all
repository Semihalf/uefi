#!/bin/sh

if [ "${BDK_ROOT}" = "" ]
then
    echo "ERROR: The BDK_ROOT environment variable is not set"
    exit 1
fi

DIR=${BDK_ROOT}/target-bin
STAGE1=${DIR}/original/bdk-stage1.bin

if [ `stat -c %s ${STAGE1}` -gt 196608 ]
then
    echo "ERROR: Stage1 image must be 192KB or less (${STAGE1})"
    exit 1
fi

#
# Create the first stage boot image
# 1) 64KB unused by Thunder
# 2) 64KB of CVM_CLIB header
# 3) 192KB of STAGE1 image
#
cat /dev/zero | head -q -c 65536 > ${DIR}/bdk-stage1.bin
echo -n CVM_CLIB | cat - /dev/zero | head -q -c 65536 >> ${DIR}/bdk-stage1.bin
cat ${STAGE1} /dev/zero | head -q -c 196608 >> ${DIR}/bdk-stage1.bin

#
# Update the Lua filesystems in the images
#
# CN88XX
${BDK_ROOT}/bin/bdk-update-romfs ${DIR}/bdk-cn88xx.bin ${DIR}/original/bdk-full-no-romfs.bin ${BDK_ROOT}/rom/full/*
${BDK_ROOT}/bin/bdk-update-romfs ${DIR}/bdk-chip-screen-cn88xx.bin ${DIR}/original/bdk-full-no-romfs.bin ${BDK_ROOT}/rom/chip-screen-cn88xx/*
${BDK_ROOT}/bin/bdk-update-romfs ${DIR}/bdk-network-perf-cn88xx.bin ${DIR}/original/bdk-full-no-romfs.bin ${BDK_ROOT}/rom/network-perf-cn88xx/*

#
# Create combined boot images for CN88XX
#
# CN88XX - BDK boot from eMMC
cat ${DIR}/bdk-stage1.bin ${DIR}/bdk-cn88xx.bin > ${DIR}/bdk-boot-emmc-cn88xx.bin

# CN88XX - BDK boot from SPI
cat ${DIR}/bdk-stage1.bin ${DIR}/bdk-cn88xx.bin > ${DIR}/bdk-boot-spi-cn88xx.bin

