# -*- csr3 -*-
# You must run "csr3 rtl" after editing this file!
---
name: VRM
enums:
  - name: VRM_TYPE_E
    title: VRM Types Register Enumeration
    attributes:
      width: "5"
    description: |
      Indicates type of device connected to this controller, as loaded into
      VRM()_MISC_INFO[VRM_TYPE] and VRM()_MISC_INFO[VRM_TYPE2].
    values:
      - name: PMB_LIN
        value: 0x00
        description: PMBus linear type.

      - name: ISL6367
        value: 0x01
        description: ISL6367 VID type.

      - name: PMB_VID
        value: 0x02
        description: PMBus VID type.

      - name: PMB_VID_TPS53641
        value: 0x04
        description: TPS53641 VID type.


structs:
  - name: VRM_TWS_TWSI_SW_S
    title: VRM TWSI Software Write Structure
    description: Format for software to write data to external regulator.
    fields:
      - name: DATA
        bits: 31..0
        description: Data to/from external regulator, includes PEC.

      - name: IA
        bits: 39..32
        description: Internal CSR address of registers within external regulator.

      - name: ADDR
        bits: 47..40
        description: Slave address. External regulator ID.

      - name: SIZE
        bits: 49..48
        description: Size of payload.

      - name: R
        bits: 50
        description: Read.

      - name: V
        bits: 51
        description: Valid.


registers:
  - name: VRM(0..1)_TWS_TWSI_SW
    title: VRM TWSI to Software Register
    address: 0x1180021000008 + a*0x1000000
    bus: RSL
    description: |
      This register allows software to write data into I2C controller directly.
      This register is for diagnostic use only.
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: V
        bits: 63
        access: RC/W/H
        reset: 0
        typical: --
        description: |
          Valid bit.
          Set on a write operation (should always be written with a 1).
          Cleared when a TWSI master-mode operation completes.
          Cleared when a TWSI configuration register access completes.
          Cleared when the TWSI device reads the register if SLONLY = 1.

      - name: SL_ONLY
        bits: 62
        access: RO
        reset: 0
        typical: 0
        description: Reserved.

      - name: EIA
        bits: 61
        access: RO
        reset: 0
        typical: 0
        description: Reserved.

      - name: OP
        bits: 60..57
        access: RO
        reset: 0x1
        typical: 0x1
        description: Reserved.

      - name: R
        bits: 56
        access: R/W/H
        reset: 0
        typical: --
        description: |
          Read bit or result. If this bit is set on a CSR write when SLONLY = 0, the operation is a
          read operation (if clear, it is a write operation).
          On a CSR read, this bit returns the result indication for the most recent master-mode
          operation, 1 = success, 0 = failure.

      - name: SOVR
        bits: 55
        access: RO
        reset: 1
        typical: 1
        description: Reserved.

      - name: SIZE_B3
        bits: 54
        access: RO
        reset: 0
        typical: 0
        description: Reserved.

      - name: SIZE
        bits: 53..52
        access: R/W/H
        reset: 0x0
        typical: --
        description: |
          Size minus one. Specifies the size in bytes of the master-mode operation.
          (0 = 1 byte, 1 = 2 bytes, 3 = 4 bytes).

      - name: SCR
        bits: 51..50
        access: RO
        reset: 0x0
        typical: 0x0
        description: Reserved.

      - name: UN_ADDR
        bits: 49..47
        access: RO
        reset: 0x0
        typical: 0x0
        description: Reserved.

      - name: ADDR
        bits: 46..40
        access: R/W/H
        reset: 0x0
        typical: --
        description: |
          Address field. The address of the remote device for a master-mode operation.
          Note that when mastering a 7-bit OP, ADDR<6:0> should not take any of the values 0x78,
          0x79, 0x7A nor 0x7B, as these 7-bit addresses are reserved to extend to 10-bit addressing.

      - name: IA
        bits: 39..32
        access: R/W/H
        reset: 0x0
        typical: 0x0
        description: Internal address. Used when launching a combined master-mode operation.

      - name: DATA
        bits: 31..0
        access: R/W/H
        reset: 0x0
        typical: --
        description: |
          Data field.
          Used on a write operation when initiating a master-mode write operation (SLONLY = 0),
          or writing a TWSI configuration register (SLONLY = 0).
          The read value is updated by:

          * A write operation to this register.

          * Master-mode completion (contains error code).

          * TWSI configuration-register read (contains result).


  - name: VRM(0..1)_ALT_FUSE
    title: VRM Alternative Fuse Register
    address: 0x1180021000018 + a*0x1000000
    bus: RSL
    attributes:
      dv_fc_scratch: "ALL"
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..40
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: TRAN_TEMP
        bits: 39..32
        access: R/W
        reset: 0x0
        typical: --
        description: Transition temperature for V calculation.

      - name: MAX_STEP
        bits: 31..24
        access: R/W
        reset: --
        typical: --
        description: V step.

      - name: SLOPE
        bits: 23..16
        access: R/W
        reset: --
        typical: --
        description: Slope.

      - name: V_BASE
        bits: 15..8
        access: R/W
        reset: --
        typical: --
        description: Base voltage. Minimum voltage that gets written to voltage regulator.

      - name: V_MAX
        bits: 7..0
        access: R/W
        reset: --
        typical: --
        description: Max voltage. Maximum voltage that gets written to voltage regulator.


  - name: VRM(0..1)_TELEMETRY_READ
    title: VRM Telemetry Read Register
    address: 0x1180021000028 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..32
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: IOUT
        bits: 31..16
        access: RO
        reset: --
        typical: --
        description: Current reading from external regulator.

      - name: VOUT
        bits: 15..0
        access: RO
        reset: --
        typical: --
        description: Voltage reading from external regulator.


  - name: VRM(0..1)_TELEMETRY_CMND
    title: VRM Telemetry Command Register
    address: 0x1180021000038 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..2
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: CMND
        bits: 1..0
        access: R/W/H
        reset: --
        typical: --
        description: |
          This command will initiate a read instruction to the external voltage regulator
          into VRM_TELEMETRY_READ.
          0x0 = Do nothing.
          0x1 = Read V.
          0x2 = Read I.
          0x3 = Read V.

          Hardware clears CMND to indicate operation completed.


  - name: VRM(0..1)_MISC_INFO
    title: VRM Miscellaneous Register
    address: 0x1180021000048 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..43
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: VRM_TYPE2
        bits: 42..40
        access: RAZ
        reset: --
        typical: --
        attributes:
          chip_pass: "o78<2.0"
        description: Reserved.

      - name: VRM_TYPE2
        bits: 42..40
        access: RO/H
        reset: --
        typical: --
        attributes:
          chip_pass: "o78>=2.0"
        description: Bits <4..2> of VRM type, enumerated with VRM_TYPE_E.

      - name: VRM_CTL_RCV_STATUS_ERROR
        bits: 39..16
        access: RO/H
        reset: --
        typical: --
        description: Holds the received status read from the external controller only for failing status.

      - name: VRM_CTL_CUR_STATE
        bits: 15..13
        access: RO/H
        reset: --
        typical: --
        description: Current state of the VRM_CTL.

      - name: VRM_TYPE
        bits: 12..11
        access: RO/H
        reset: --
        typical: --
        description: |
          Bits <1:0> of VRM type indicating the type of device connected to this controller.
          Enumerated with VRM_TYPE_E.

      - name: BOOT_SEQ
        bits: 10
        access: RO/H
        reset: --
        typical: --
        description: Boot sequence was completed.

      - name: TS_FUSE_STS
        bits: 9
        access: RO/H
        reset: --
        typical: --
        description: Set if VRM fuses were loaded.

      - name: VRM_FUSE_STS
        bits: 8
        access: RO/H
        reset: --
        typical: --
        description: Set if VRM fuses were loaded.

      - name: CMND
        bits: 7..0
        access: RO/H
        reset: --
        typical: --
        description: Last command send to the external voltage regulator.


  - name: VRM(0..1)_TS_TEMP_CONV_CTL
    title: VRM Temp Sensor Analog Alternate Conversion Register
    address: 0x1180021000058 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..13
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: RESET_SM
        bits: 12
        access: R/W
        reset: 0
        typical: --
        description: |
          This will force the temperature conversion state machine into the reset state until
          RESET_SM is cleared.

      - name: SW_ACCESS
        bits: 11
        access: R/W
        reset: 0
        typical: --
        description: If set, software controls inputs of analog temperature sensor.

      - name: TS_SWITCH
        bits: 10..2
        access: R/W
        reset: 0x14e
        typical: --
        description: Alternate software access to control temperature sensor switches.

      - name: TS_CURR2EN
        bits: 1
        access: R/W
        reset: 0
        typical: --
        description: Controls curr2_en pin on analog temperature sensor block.

      - name: STROBE
        bits: 0
        access: R/W
        reset: 0
        typical: --
        description: Controls strobe pin on analog temperature sensor block.


  - name: VRM(0..1)_TS_TEMP_CONV_RESULT
    title: VRM Temp Sensor Result Register
    address: 0x1180021000068 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..24
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: N_VALID
        bits: 23
        access: RO/H
        reset: 0
        typical: --
        description: When set N_VALUE is valid.

      - name: N_VALUE
        bits: 22..12
        access: RO/H
        reset: 0x0
        typical: --
        description: N cycle count values after calibration initiated. Qualified by N_VALID.

      - name: TEMP_VALID
        bits: 11
        access: RO/H
        reset: 0
        typical: --
        description: |
          When set TEMP_CORRECTED is valid.
          This bit is pulsed on each conversion, and as such software may not be able to observe the
          cycle in which TEMP_VALID is set.

      - name: TEMP_CORRECTED
        bits: 10..0
        access: RO/H
        reset: 0x0
        typical: --
        description: |
          Corrected temperature read out from the temp sensor module.
          Has valid data after TEMP_VALID transitions.


  - name: VRM(0..1)_TS_TEMP_CONV_COEFF_FSM
    title: VRM Temp Sensor Conversion Coefficient and FSM Register
    address: 0x1180021000078 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..58
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: T_FSM
        bits: 57..48
        access: R/W
        reset: 0xfa
        typical: --
        description: Sets time interval for FSM update.

      - name: --
        bits: 47..38
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: COEFF_A
        bits: 37..32
        access: R/W
        reset: 0x1f
        typical: --
        description: |
          Coefficient A value for polynomial fit.
          _ <37> is a sign bit to flip the shifted results.
          _ <36:32> dictates the amount of right shift.

      - name: --
        bits: 31..25
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: COEFF_B
        bits: 24..16
        access: R/W
        reset: 0x100
        typical: --
        description: |
          Coefficient B value for polynomial fit. It should be a positive number and between 1 and
          2.
          _ <24> is the integer part should always be 1.
          _ <23:16> form the fractional part.

      - name: --
        bits: 15..12
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: COEFF_C
        bits: 11..0
        access: R/W
        reset: 0x0
        typical: --
        description: |
          Coefficient C value for polynomial fit.
          A 2's complement number.


  - name: VRM(0..1)_TS_TEMP_NOFF_MC
    title: VRM Temp Sensor Noff Coefficient Register
    address: 0x1180021000088 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..28
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: MC
        bits: 27..16
        access: R/W
        reset: 0xbb8
        typical: --
        description: MC value, default is 3000 decimal.

      - name: --
        bits: 15..11
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: NOFF
        bits: 10..0
        access: R/W
        reset: 0x0
        typical: 0x0
        description: |
          N cycle count offset, used to subtract the appropriate count from N cycle.
          It should be such that at 0 degrees C, the difference between NOFF and NCYCLE is 0.


  - name: VRM(0..1)_FUSE_BYPASS
    title: VRM Fuse Bypass Register
    address: 0x1180021000098 + a*0x1000000
    bus: RSL
    attributes:
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..3
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: CTL_HW_BYPASS
        bits: 2
        access: R/W
        reset: 0
        typical: 0
        description: |
          If set, bypass VRM control hardware responsible for controlling external voltage
          regulator so software can send commands to the regulator.

      - name: CTL_FUSE_BYPASS
        bits: 1
        access: R/W
        reset: 0
        typical: 0
        description: If set, bypass V_MAX, V_BASE, MAX_STEP, SLOPE, TRAN_TEMP fuses which feed the PMBus VRM controller.

      - name: TS_FUSE_BYPASS
        bits: 0
        access: R/W
        reset: 0
        typical: 0
        description: If set, bypass MC and NOFF fuses which feed the temperature sensor.


  - name: VRM(0..1)_DEVICE_STATUS
    title: VRM Device Status Register
    address: 0x11800210000A8 + a*0x1000000
    bus: RSL
    attributes:
      chip_pass: "o78>=2.0"
      exempt_natural_alignment: "a"
    fields:
      - name: --
        bits: 63..18
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: REMOVE_IDLE
        bits: 17
        access: R/W
        reset: 0
        typical: 0
        description: |
          When set, will remove IDLE as described below.
          Software should not set this bit, unless the reason for PEC mismatch is known.

      - name: STATUS_IDLE
        bits: 16
        access: RO/H
        reset: 0
        typical: 0
        description: |
          If set, faulty external controller operation was detected, for example in the ISL636*.
          Sixteen attempts were made to communicate with device that came back with PEC faults.
          See STATUS_CML in the PMbus documentation.

      - name: STATUS_BYTE
        bits: 15..8
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Reads STATUS_BYTE register. See PMBus documentation.

      - name: STATUS_CML
        bits: 7..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Reads STATUS_CML register. See PMBus documentation.



