# -*- csr3 -*-
# You must run "csr3 rtl" after editing this file!
---
name: MIO_NDF
attributes:
  exempt_title_check: "True"
registers:
  - name: NDF_CMD
    address: 0x1070001000000
    bus: NCB
    description: |
      When SW reads this csr, RD_VAL bit in NDF_MISC csr is cleared to 0. SW must always write all 8
      bytes whenever it writes
      this csr. If there are fewer than 8 bytes left in the command sequence that SW wants the NAND
      flash controller to execute, it
      must insert Idle (WAIT) commands to make up 8 bytes. SW also must ensure there is enough
      vacancy in the command fifo to accept these
      8 bytes, by first reading the FR_BYT field in the NDF_MISC csr.
    fields:
      - name: NF_CMD
        bits: 63..0
        access: R/W
        reset: 0x0
        typical: --
        description: 8 Command Bytes


  - name: NDF_MISC
    address: 0x1070001000008
    bus: NCB
    description: |
      "NBR_HWM this field specifies the high water mark for the NCB outbound load/store commands
      receive fifo.
        the fifo size is 16 entries.
      WAIT_CNT this field allows glitch filtering of the WAIT_n input to octeon, from Flash Memory.
      The count
        represents number of eclk cycles.
      FR_BYT  this field specifies # of unfilled bytes in the command fifo. Bytes become unfilled as
      commands
        complete execution and exit. (fifo is 256 bytes when BT_DIS=0,  and 1536 bytes when
      BT_DIS=1)
      RD_DONE this W1C bit is set to 1 by HW when it reads the last 8 bytes out of the command fifo,
        in response to RD_CMD bit being set to 1 by SW.
      RD_VAL  this read only bit is set to 1 by HW when it reads next 8 bytes from command fifo in
      response
        to RD_CMD bit being set to 1. A SW read of NDF_CMD csr clears this bit to 0.
      RD_CMD  this R/W bit starts read out from the command fifo, 8 bytes at a time. SW should first
      read the
      RD_VAL bit in  this csr to see if next 8 bytes from the command fifo are available in the
      NDF_CMD csr. All command fifo reads start and end on an 8 byte boundary. A RD_CMD in the
        middle of command execution will cause the execution to freeze until RD_DONE is set to 1.
      RD_CMD
        bit will be cleared on any NDF_CMD csr write by SW.
      BT_DMA  this indicates to the NAND flash boot control state machine that boot dma read can
      begin.
        SW should set this bit to 1 after SW has loaded the command fifo. HW sets the bit to 0
        when boot dma command execution is complete. If chip enable 0 is not nand flash, this bit is
        permanently 1'b0 with SW writes ignored. Whenever BT_DIS=1, this bit will be 0.
      BT_DIS  this R/W bit indicates to NAND flash boot control state machine that boot operation
      has ended.
        whenever this bit changes from 0 to a 1, the command fifo is emptied as a side effect. This
      bit must
        never be set when booting from nand flash and region zero is enabled.
      EX_DIS  When 1, command execution stops after completing execution of all commands currently
      in the command
        fifo. Once command execution has stopped, and then new commands are loaded into the command
      fifo, execution
        will not resume as long as this bit is 1. When this bit is 0, command execution will resume
      if command fifo
        is not empty. EX_DIS should be set to 1, during boot i.e. when BT_DIS = 0.
      RST_FF  reset command fifo to make it empty, any command inflight is not aborted before
      reseting
        the fifo. The fifo comes up empty at the end of power on reset."
    attributes:
      exempt_w1c_w: "True"
    fields:
      - name: --
        bits: 63..28
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: MB_DIS
        bits: 27
        access: R/W
        reset: 0
        typical: --
        description: |
          Disable multibit error hangs and allow boot loads
          or boot dma's proceed as if no multi bit errors
          occured. HW will fix single bit errors as usual

      - name: NBR_HWM
        bits: 26..24
        access: R/W
        reset: 0x3
        typical: 0x3
        description: Hi Water mark for NBR fifo or load/stores

      - name: WAIT_CNT
        bits: 23..18
        access: R/W
        reset: 0x14
        typical: --
        description: WAIT input filter count

      - name: FR_BYT
        bits: 17..7
        access: RO/H
        reset: 0x0
        typical: --
        description: Number of unfilled Command fifo bytes

      - name: RD_DONE
        bits: 6
        access: R/W1C/H
        reset: 0
        typical: 0
        description: |
          This W1C bit is set to 1 by HW when it completes
          command fifo read out, in response to RD_CMD

      - name: RD_VAL
        bits: 5
        access: RO/H
        reset: 0
        typical: --
        description: |
          This RO bit is set to 1 by HW when it reads next 8
          bytes from Command fifo into the NDF_CMD csr
          SW reads NDF_CMD csr, HW clears this bit to 0

      - name: RD_CMD
        bits: 4
        access: R/W
        reset: 0
        typical: 0
        description: |
          When 1, HW reads out contents of the Command fifo 8
          bytes at a time into the NDF_CMD csr

      - name: BT_DMA
        bits: 3
        access: R/W
        reset: 0
        typical: --
        description: When set to 1, boot time dma is enabled

      - name: BT_DIS
        bits: 2
        access: R/W
        reset: 0
        typical: 1
        description: |
          When boot operation is over SW must set to 1
          causes boot state mchines to sleep

      - name: EX_DIS
        bits: 1
        access: R/W
        reset: 0
        typical: 0
        description: |
          When set to 1, suspends execution of commands at
          next command in the fifo.

      - name: RST_FF
        bits: 0
        access: R/W
        reset: 0
        typical: 0
        description: |
          1=reset command fifo to make it empty,
          0=normal operation


  - name: NDF_ECC_CNT
    address: 0x1070001000010
    bus: NCB
    fields:
      - name: --
        bits: 63..32
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: XOR_ECC
        bits: 31..8
        access: RO/H
        reset: 0x0
        typical: --
        description: |
          result of XOR of ecc read bytes and ecc genarated
          bytes. The value pertains to the last 1 bit ecc err

      - name: ECC_ERR
        bits: 7..0
        access: RO/H
        reset: 0x0
        typical: --
        description: |
          "Count = # of 1 bit errors fixed during boot
          This count saturates instead of wrapping around."


  - name: NDF_BT_PG_INFO
    address: 0x1070001000018
    bus: NCB
    description: |
      NDF_BT_PG_INFO provides page size and number of column plus row address cycles information. SW
      writes to this CSR
        during boot from Nand Flash. Additionally SW also writes the multiplier value for timing
      parameters. This value is
        used during boot, in the SET_TM_PARAM command. This information is used only by the boot
      load state machine and is
        otherwise a don't care, once boot is disabled. Also, boot dma's do not use this value.
      Bytes per Nand Flash page = 2 ** (SIZE + 1) times 256 bytes.
        512, 1k, 2k, 4k, 8k, 16k, 32k and 64k are legal bytes per page values
      Legal values for ADR_CYC field are 3 through 8. SW CSR writes with a value less than 3 will
      write a 3 to this
        field, and a SW CSR write with a value greater than 8, will write an 8 to this field.
    fields:
      - name: --
        bits: 63..11
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: T_MULT
        bits: 10..7
        access: R/W
        reset: --
        typical: --
        description: |
          Boot time TIM_MULT[3:0] field of SET__TM_PAR[63:0]
          command

      - name: ADR_CYC
        bits: 6..3
        access: R/W
        reset: --
        typical: --
        description: "# of column address cycles"

      - name: SIZE
        bits: 2..0
        access: R/W
        reset: --
        typical: --
        description: bytes per page in the nand device


  - name: NDF_INT
    address: 0x1070001000020
    bus: NCB
    description: |
      FULL status is updated when the command fifo becomes full as a result of SW writing a new
      command to it.
      EMPTY status is updated when the command fifo becomes empty as a result of command execution
      unit fetching the
        last instruction out of the command fifo.
    fields:
      - name: --
        bits: 63..7
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: OVRF
        bits: 6
        access: R/W1C/H
        reset: 0
        typical: --
        description: |
          NDF_CMD write when fifo is full. Generally a
          fatal error.

      - name: ECC_MULT
        bits: 5
        access: R/W1C/H
        reset: 0
        typical: --
        description: Multi bit ECC error detected during boot

      - name: ECC_1BIT
        bits: 4
        access: R/W1C/H
        reset: 0
        typical: --
        description: Single bit ECC error detected and fixed during boot

      - name: SM_BAD
        bits: 3
        access: R/W1C/H
        reset: 0
        typical: --
        description: One of the state machines in a bad state

      - name: WDOG
        bits: 2
        access: R/W1C/H
        reset: 0
        typical: --
        description: Watch Dog timer expired during command execution

      - name: FULL
        bits: 1
        access: R/W1C/H
        reset: 0
        typical: --
        description: Command fifo is full

      - name: EMPTY
        bits: 0
        access: R/W1C/H
        reset: 0
        typical: --
        description: Command fifo is empty


  - name: NDF_INT_EN
    address: 0x1070001000028
    bus: NCB
    attributes:
      dv_fc_scratch: "ALL"
    fields:
      - name: --
        bits: 63..7
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: OVRF
        bits: 6
        access: R/W/H
        reset: 0
        typical: --
        description: Wrote to a full command fifo

      - name: ECC_MULT
        bits: 5
        access: R/W/H
        reset: 0
        typical: --
        description: Multi bit ECC error detected during boot

      - name: ECC_1BIT
        bits: 4
        access: R/W/H
        reset: 0
        typical: --
        description: Single bit ECC error detected and fixed during boot

      - name: SM_BAD
        bits: 3
        access: R/W/H
        reset: 0
        typical: --
        description: One of the state machines in a bad state

      - name: WDOG
        bits: 2
        access: R/W/H
        reset: 0
        typical: --
        description: Watch Dog timer expired during command execution

      - name: FULL
        bits: 1
        access: R/W/H
        reset: 0
        typical: --
        description: Command fifo is full

      - name: EMPTY
        bits: 0
        access: R/W/H
        reset: 0
        typical: --
        description: Command fifo is empty


  - name: NDF_DRBELL
    address: 0x1070001000030
    bus: NCB
    description: |
      SW csr writes will increment CNT by the signed 8 bit value being written. SW csr reads return
      the current CNT value.
      HW will also modify the value of the CNT field. Everytime HW executes a BUS_ACQ[15:0] command,
      to arbitrate and win the
      flash bus, it decrements the CNT field by 1. If the CNT field is already 0 or negative, HW
      command execution unit will
      stall when it fetches the new BUS_ACQ[15:0] command, from the command fifo. Only when the SW
      writes to this CSR with a
      non-zero data value, can the execution unit come out of the stalled condition, and resume
      execution.
      The intended use of this doorbell CSR is to control execution of the Nand Flash commands. The
      NDF execution unit
      has to arbitrate for the flash bus, before it can enable a Nand Flash device connected to the
      Octeon chip, by
      asserting the device's chip enable. Therefore SW should first load the command fifo, with a
      full sequence of
      commands to perform a Nand Flash device task. This command sequence will start with a bus
      acquire command and
      the last command in the sequence will be a bus release command. The execution unit will start
      execution of
      the sequence only if the [CNT] field is non-zero when it fetches the bus acquire command,
      which is the first
      command in this sequence. SW can also, load multiple such sequences, each starting with a chip
      enable command
      and ending with a chip disable command, and then write a non-zero data value to this csr to
      increment the
      CNT field by the number of the command sequences, loaded to the command fifo.
    fields:
      - name: --
        bits: 63..8
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: CNT
        bits: 7..0
        access: R/W/H
        reset: 0x0
        typical: --
        description: Doorbell count register, 2's complement 8 bit value


  - name: NDF_ST_REG
    address: 0x1070001000038
    bus: NCB
    fields:
      - name: --
        bits: 63..16
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: EXE_IDLE
        bits: 15
        access: RO/H
        reset: 1
        typical: --
        description: |
          Command Execution status 1=IDLE, 0=Busy
          1 means execution of command sequence is complete
          and command fifo is empty

      - name: EXE_SM
        bits: 14..11
        access: RO/H
        reset: 0x0
        typical: --
        description: Command Execution State machine states

      - name: BT_SM
        bits: 10..7
        access: RO/H
        reset: 0x0
        typical: --
        description: Boot load and Boot dma State machine states

      - name: RD_FF_BAD
        bits: 6
        access: RO/H
        reset: 0
        typical: --
        description: CMD fifo read back State machine in bad state

      - name: RD_FF
        bits: 5..4
        access: RO/H
        reset: 0x0
        typical: --
        description: CMD fifo read back State machine states

      - name: MAIN_BAD
        bits: 3
        access: RO/H
        reset: 0
        typical: --
        description: Main State machine in bad state

      - name: MAIN_SM
        bits: 2..0
        access: RO/H
        reset: 0x0
        typical: --
        description: Main State machine states



