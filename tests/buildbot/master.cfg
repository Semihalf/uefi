# -*- python -*-
# ex: set syntax=python:


DEFAULT_PASSWORD = "caveo123"
SVN_URL = "svn://casw.caveonetworks.com/svn/octeon/"
MAKE = "make -j4 -s"
MASTER_NAME = "chad-pci"
MASTER_PORT = 8010
#MAIL_TO = ["kreese@caviumnetworks.com", "rfranz@caviumnetworks.com"]
MAIL_TO = ["kreese@caviumnetworks.com"]

BRANCHES = {}
BRANCHES["Trunk"] = "bdk/trunk"

DEB32_SLAVES = ["qemu-debian32-slave1", "qemu-debian32-slave2"]
DEB64_SLAVES = ["chad-pci-debian64-slave1", "chad-pci-debian64-slave2"]
PCI_SLAVES = ["i7-pci-debian64-slave1"]
ALL_SLAVES = []
ALL_SLAVES.extend(DEB32_SLAVES)
ALL_SLAVES.extend(DEB64_SLAVES)
ALL_SLAVES.extend(PCI_SLAVES)


####### PYTHON IMPORTS

from buildbot.buildslave import BuildSlave
from buildbot.changes.svnpoller import SVNPoller
from buildbot.process import factory
from buildbot.scheduler import Scheduler
from buildbot.status import html
from buildbot.status import mail
from buildbot.steps.shell import Compile
from buildbot.steps.shell import ShellCommand
from buildbot.steps.shell import Test
from buildbot.steps.shell import WithProperties
from buildbot.steps.source import SVN


####### GLOBAL CONFIG

c = BuildmasterConfig = {}
c['buildbotURL'] = "http://%s:%s/" % (MASTER_NAME, MASTER_PORT)
c['builders'] = []
c['projectName'] = "Octeon BDK"
c['projectURL'] = "http://chad-pci:8010/"
c['schedulers'] = []
c['slavePortnum'] = 9989
c['slaves'] = []
c['status'] = []
builder_names_by_branch = {}

####### STATUS TARGETS

# 'status' is a list of Status Targets. The results of each build will be
# pushed to these targets. buildbot/status/*.py has a variety to choose from,
# including web pages, email senders, and IRC bots.

c['status'].append(html.WebStatus(http_port=MASTER_PORT, allowForce=True))
#c['status'].append(mail.MailNotifier(fromaddr="buildbot@" + MASTER_NAME,
#			extraRecipients=MAIL_TO, sendToInterestedUsers=False,
#			lookup="caviumnetworks.com"))


####### BUILDSLAVES

# the 'slaves' list defines the set of allowable buildslaves. Each element is
# a tuple of bot-name and bot-password. These correspond to values given to
# the buildslave's mktap invocation.

for slave in ALL_SLAVES:
    c['slaves'].append(BuildSlave(slave, DEFAULT_PASSWORD, max_builds=1))


####### CHANGESOURCES

# the 'change_source' setting tells the buildmaster how it should find out
# about source code changes. Any class which implements IChangeSource can be
# put here: there are several in buildbot/changes/*.py to choose from.

def svn_branch_parser(path):
    pieces = path.split('/')
    project = pieces.pop(0)
    type = pieces.pop(0)
    if type == 'trunk':
        branch = "trunk"
    elif type == "branches":
    	branch_name = pieces.pop(0)
	if branch_name == "users":
	    branch = "branches/users" + pieces.pop(0)
	else:
	    branch = "branches/" + branch_name
    elif type == "tags":
    	tag_name = pieces.pop(0)
	if tag_name == "users":
	    branch = "tags/users" + pieces.pop(0)
	else:
	    branch = "tags/" + tag_name
    else:
    	print "svn_branch_parser: Unknown branch format %s. Update buildbot master.cfg" % path
        return None
    print "svn_branch_parser: Using branch \"%s\"" % branch
    return (project + "/" + branch, "/".join(pieces))

c['change_source'] = SVNPoller(SVN_URL, split_file=svn_branch_parser, pollinterval=30)


####### BUILDERS

# the 'builders' list defines the Builders. Each one is configured with a
# dictionary, using the following keys:
#  name (required): the name used to describe this bilder
#  slavename (required): which slave to use, must appear in c['bots']
#  builddir (required): which subdirectory to run the builder in
#  factory (required): a BuildFactory to define how the build is run
#  periodicBuildTime (optional): if set, force a build every N seconds

# buildbot/process/factory.py provides several BuildFactory classes you can
# start with, which implement build processes for common targets (GNU
# autoconf projects, CPAN perl modules, etc). The factory.BuildFactory is the
# base class, and is configured with a series of BuildSteps. When the build
# is run, the appropriate buildslave is told to execute each Step in turn.

# the first BuildStep is typically responsible for obtaining a copy of the
# sources. There are source-obtaining Steps in buildbot/process/step.py for
# CVS, SVN, and others.

COMMAND_ENV = {}
COMMAND_PREFIX = ""
FACTORY = None

# This function adds a new command to a build factory. The command can
# have one of the following types: 'S'hell, 'C'ompile, or 'T'est. Name
# should be something short. Command will be executed with COMMAND_PREFIX
# prepeneded to it. COMMAND_PREFIX should normally run env-setup.
def addCmd(type, name, command = "", timeout=60*60):
    global COMMAND_ENV
    global COMMAND_PREFIX
    global FACTORY
    # Buildnumber is a integer, the rest of the properties are strings. Even
    # got_revision is a string of the svn revision id
    COMMAND_ENV["buildnumber"] = WithProperties("%d", "buildnumber")
    for key in ["branch", "buildername", "slavename"]: #, "got_revision"]:
	COMMAND_ENV[key] = WithProperties("%s", key)
    command = COMMAND_PREFIX + command
    if type == 'S':
        FACTORY.addStep(ShellCommand, command=command,
	    description="running " + name, descriptionDone=name,
	    flunkOnFailure=True, env=COMMAND_ENV, timeout=timeout)
    elif type == 'C':
        FACTORY.addStep(Compile, command=command,
	    description="making " + name, descriptionDone="make " + name,
	    warnOnWarnings=True, flunkOnFailure=True, env=COMMAND_ENV)
    elif type == 'T':
        FACTORY.addStep(Test, command=command,
	    description="running " + name, descriptionDone=name,
	    warnOnFailure=True, env=COMMAND_ENV, timeout=timeout)
    else:
        raise Exception("Illegal addCmd() type=%s" % type)

# Utility function to add a builder for a build factory on multiple slaves.
# Name must be unique and will show up as the column headers in the waterfall
# display
def addBuilder(category, name, slaves, factory):
    global c
    builder = {'category': category, 'name': name, 'slavenames': slaves,
               'builddir': name, 'factory': factory}
    c['builders'].append(builder)

# Loop through all branches adding builds for each one
for branch in sorted(BRANCHES, reverse=True):
    builder_names_by_branch[branch] = []

    COMMAND_ENV = {}
    COMMAND_PREFIX = "export OCTEON_ROOT=`pwd`/sdk && export BDK_ROOT=`pwd` && export PATH=${OCTEON_ROOT}/tools/bin:${PATH} && "
    FACTORY = factory.BuildFactory()
    FACTORY.addStep(SVN(mode="copy", baseURL=SVN_URL, defaultBranch="bdk/trunk"))
    FACTORY.addStep(ShellCommand(command=WithProperties("svn export -r%s " + SVN_URL + "/sdk-base/trunk/sdk sdk", "got_revision"), description="Getting SDK", descriptionDone="SDK export", flunkOnFailure=True))
    addCmd('S', "Setting tools","ln -sf /nfs/sdk/2.1.0-395/OCTEON-SDK/tools sdk/tools")
    addCmd('C', "libc",     	MAKE + " -C libc")
    addCmd('C', "libbdk",   	MAKE + " -C libbdk")
    addCmd('C', "docs",   	MAKE + " -C docs")
    addCmd('C', "bdk-boot",   	MAKE + " -C bdk-boot")
    addCmd('C', "utils",   	MAKE + " -C utils")
    addCmd('C', "release",   	MAKE + " release")
    addCmd('C', "crypto",   	MAKE + " -C tests/hw-and-sim/crypto")
    addCmd('C', "pcie-dma-test", MAKE + " -C tests/hw-only/pcie-dma-test")
    addCmd('T', "crypto cn63xx",	MAKE + " -C tests/hw-and-sim/crypto SIM=cn63xx test")
    addCmd('T', "crypto cn68xx",	MAKE + " -C tests/hw-and-sim/crypto SIM=cn68xx test")
    addCmd('T', "crypto cn66xx",	MAKE + " -C tests/hw-and-sim/crypto SIM=cn66xx test")
    addCmd('S', "Verify results dir",	"ssh chad-pci mkdir -p build-results/${slavename}/")
    addCmd('S', "Copy release",		"scp octeon-bdk-*.tgz chad-pci:build-results/${slavename}/")
    name = "BDK-%s-32" % branch
    addBuilder(name, name, DEB32_SLAVES, FACTORY)
    builder_names_by_branch[branch].append(name)
    name = "BDK-%s-64" % branch
    addBuilder(name, name, DEB64_SLAVES, FACTORY)
    builder_names_by_branch[branch].append(name)


####### SCHEDULERS

print "############### builders by branches ##################"
print builder_names_by_branch
print "#######################################################"

for branch_name in BRANCHES:
	c['schedulers'].append(Scheduler(name=branch_name,
                                         branch=BRANCHES[branch_name],
        	                         treeStableTimer=1*60,
                	                 builderNames=builder_names_by_branch[branch_name]))

