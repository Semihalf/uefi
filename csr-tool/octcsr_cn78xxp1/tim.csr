# -*- csr3 -*-
# You must run "csr3 rtl" after editing this file!
---
name: TIM
enums:
  - name: TIM_INTSN_E
    title: TIM Interrupt Source Enumeration
    attributes:
      width: "20"
    description: Enumerates the different TIM generated interrupts.
    values:
      - name: TIM_ECCERR_SBE
        value: 0x58040
        attributes:
          cib_rtl_module: "tim"
        description: See TIM_INT_ECCERR[SBE].

      - name: TIM_ECCERR_DBE
        value: 0x58041
        attributes:
          cib_rtl_module: "tim"
        description: See TIM_INT_ECCERR[DBE].

      - name: TIM_ECCERR_CTL_SBE
        value: 0x58042
        attributes:
          cib_rtl_module: "tim"
        description: See TIM_INT_ECCERR[CTL_SBE].

      - name: TIM_ECCERR_CTL_DBE
        value: 0x58043
        attributes:
          cib_rtl_module: "tim"
        description: See TIM_INT_ECCERR[CTL_DBE].

      - name: TIM_RING(0..63)_SLOW
        value: 0x58080 + a
        attributes:
          cib_rtl_module: "tim"
        description: See TIM_INT0[INT0<a>].


structs:
  - name: TIM_MEM_BUCKET_S
    title: TIM Memory Bucket Structure
    fields:
      - name: FIRST_CHUNK
        bits: w0(63..0)
        description: |
          Pointer to first chunk memory. <63:41,2:0> must be zero. Updated by software when a first
          chunk is added. Read by timer hardware.

      - name: CHUNK_REMAINDER
        bits: w1(31..0)
        description: |
          Number of remaining entries for software to enter in the list. This number should always
          be smaller than chunk size. This field is decremented by software whenever software adds
          an entry. If [NUM_ENTRIES] is non-zero, written to zeros by hardware when hardware
          processes the entry unless TIM_RING()_CTL1[ENA_PRD] is set.

      - name: NUM_ENTRIES
        bits: w1(63..32)
        description: |
          Number of entries that software added to the list. Incremented whenever software adds an
          entry. Written to zeros by hardware when hardware processes the list unless
          TIM_RING()_CTL1[ENA_PRD] is set.

      - name: CURRENT_CHUNK
        bits: w2(63..0)
        description: |
          Not used by timer hardware. Points to the last chunk in the list and is updated by
          software whenever chunk is added to the list.

      - name: PAD
        bits: w3(63..0)
        description: Padding, not used by hardware.


  - name: TIM_MEM_ENTRY_S
    title: TIM Memory Entry Structure
    description: |
      Chunks contain 32-byte entries:
    fields:
      - name: WQP
        bits: 41..0
        description: |
          Pointer to a work-queue entry. An all-zero [WQP] is not sent to the SSO and may be used as
          a NOP. <2:0> must be zero.

      - name: --
        bits: 49..42
        description: |
          Reserved. INTERNAL: <43:42> are for 44 bit addresses.

      - name: TT
        bits: 51..50
        description: SSO tag type.

      - name: GRP
        bits: 61..52
        description: SSO group. Note the upper two bits correspond to a node number.

      - name: --
        bits: 63..62
        description: |
          Reserved. INTERNAL: For group expansion.


registers:
  - name: TIM_REG_FLAGS
    title: Timer Flags Register
    address: 0x1180058000000
    bus: RSL
    description: This register provides flags for TIM.
    fields:
      - name: --
        bits: 63..7
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: GPIO_EDGE
        bits: 6..5
        access: R/W
        reset: 0x0
        typical: 0x0
        description: |
          Edge used for GPIO timing.
          0x0 = no edges and the timer tick is not generated.
          0x1 = TIM counts low to high transitions.
          0x2 = TIM counts high to low transitions.
          0x3 = TIM counts both low to high and high to low transitions.

      - name: --
        bits: 4..3
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: RESET
        bits: 2
        access: WO
        reset: 0
        typical: 0
        description: Reset. One-shot pulse for free-running timer FR_RN_HT.

      - name: --
        bits: 1
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: ENA_TIM
        bits: 0
        access: R/W
        reset: 0
        typical: 0
        attributes:
          regtest_force: "0"
        description: |
          When set, TIM is in normal operation. When clear, time is effectively stopped for all
          rings in TIM.

          TIM has a counter (see FR_RN_HT) that causes a periodic tick. This counter is shared by
          all rings. Each Timer tick causes the hardware to decrement the time count for all enabled
          rings.

          When ENA_TIM = 0, the hardware stops the shared periodic counter, FR_RN_HT, so there are
          no more ticks, and there are no more new bucket traversals.

          If ENA_TIM transitions 1->0, TIM longer creates new bucket traversals, but does traverse
          any rings that previously expired and are pending hardware traversal.


  - name: TIM_ECC_CFG
    title: Timer ECC Configuration Register
    address: 0x1180058000018
    bus: RSL
    fields:
      - name: --
        bits: 63..3
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: ECC_FLP_SYN
        bits: 2..1
        access: R/W
        reset: 0x0
        typical: 0x0
        description: |
          ECC flip syndrome. Flip the ECC's syndrome for testing purposes, to test SBE and DBE ECC
          interrupts.

      - name: ECC_EN
        bits: 0
        access: R/W
        reset: 1
        typical: 1
        description: Enable ECC correction of the ring data structure memory.


  - name: TIM_BIST_RESULT
    title: Timer BIST Result Register
    address: 0x1180058000020
    bus: RSL
    description: |
      This register provides access to the internal timer BIST results. Each bit is the BIST result
      of an individual memory (per bit, 0 = pass and 1 = fail).
    attributes:
      dv_bist_all_fail_test: "ALL"
    fields:
      - name: --
        bits: 63..4
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: TSTMP_MEM
        bits: 3
        access: RO/H
        reset: --
        typical: 0
        description: BIST result of the Time Stamp memory.

      - name: WQE_FIFO
        bits: 2
        access: RO/H
        reset: --
        typical: 0
        description: BIST result of the NCB_WQE FIFO.

      - name: LSLR_FIFO
        bits: 1
        access: RO/H
        reset: --
        typical: 0
        description: BIST result of the NCB_LSLR FIFO.

      - name: RDS_MEM
        bits: 0
        access: RO/H
        reset: --
        typical: 0
        description: BIST result of the RDS memory.


  - name: TIM_INT0
    title: Timer Ring Error Interrupt Register
    address: 0x1180058000030
    bus: RSL
    description: |
      A ring is in error if its interval has elapsed more than once without having been serviced,
      either due to too many events in this ring's previous interval, or another ring having too
      many events to process within this ring's interval. This is usually a programming error where
      the number of entries in the bucket is too large for the interval specified across the rings.
      When in error, TIM may process events in an interval later than requested. Any bit in the INT
      field should be cleared by writing one to it.
    fields:
      - name: INT0
        bits: 63..0
        access: R/W1C/H
        reset: 0x0
        typical: 0x0
        description: |
          Interrupt bit per ring. Each bit indicates the ring number in error. Throws INTSN
          TIM_INTSN_E::TIM_RING()_SLOW.


  - name: TIM_INT_ECCERR
    title: Timer ECC Error Interrupt Register
    address: 0x1180058000060
    bus: RSL
    fields:
      - name: --
        bits: 63..4
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: CTL_DBE
        bits: 3
        access: R/W1C/H
        reset: 0
        typical: 0
        description: |
          TIM CTL memory had a double-bit error. Throws INTSN TIM_INTSN_E::TIM_ECCERR_CTL_DBE.

      - name: CTL_SBE
        bits: 2
        access: R/W1C/H
        reset: 0
        typical: 0
        description: |
          TIM CTL memory had a single-bit error. Throws INTSN TIM_INTSN_E::TIM_ECCERR_CTL_SBE.

      - name: DBE
        bits: 1
        access: R/W1C/H
        reset: 0
        typical: 0
        description: |
          TIM RDS memory had a double-bit error. Throws INTSN TIM_INTSN_E::TIM_ECCERR_DBE.

      - name: SBE
        bits: 0
        access: R/W1C/H
        reset: 0
        typical: 0
        description: |
          TIM RDS memory had a single-bit error. Throws INTSN TIM_INTSN_E::TIM_ECCERR_SBE.


  - name: TIM_INT_ECCERR_EVENT0
    title: Timer ECC Error Interrupt Event 0 Register
    address: 0x1180058000070
    bus: RSL
    fields:
      - name: --
        bits: 63..14
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: SYND
        bits: 13..7
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: ECC syndrome bits.

      - name: ADD
        bits: 6..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Memory address where the error occurred.


  - name: TIM_INT_ECCERR_EVENT1
    title: Timer ECC Error Interrupt Event 1 Register
    address: 0x1180058000078
    bus: RSL
    fields:
      - name: --
        bits: 63..55
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: ORG_ECC
        bits: 54..48
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Original ECC bits where the error occurred.

      - name: ORG_RDS_DAT
        bits: 47..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Memory original data where the error occurred.


  - name: TIM_GPIO_EN
    title: Timer GPIO Enable Register
    address: 0x1180058000080
    bus: RSL
    fields:
      - name: GPIO_EN
        bits: 63..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: |
          Each bit corresponds to rings [63:0] respectively. This register reflects the values
          written to TIM_RING()_CTL1 [ENA_GPIO]. For debug only; Reserved.


  - name: TIM_DBG2
    title: Timer Debug 2 Register
    address: 0x11800580000A0
    bus: RSL
    fields:
      - name: MEM_ALLOC_REG
        bits: 63..56
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: IOI load memory allocation status.

      - name: --
        bits: 55..53
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: GNT_FIFO_LEVEL
        bits: 52..49
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: IOI grant FIFO level.

      - name: FPA_FIFO_LEVEL
        bits: 48..46
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: FPA FIFO level.

      - name: RWF_FIFO_LEVEL
        bits: 45..40
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: IOI requests FIFO level.

      - name: WQE_FIFO_LEVEL
        bits: 39..32
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: IOI WQE LD FIFO level.

      - name: --
        bits: 31..16
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: FSM3_STATE
        bits: 15..12
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: FSM 3 current state.

      - name: FSM2_STATE
        bits: 11..8
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: FSM 2 current state.

      - name: FSM1_STATE
        bits: 7..4
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: FSM 1 current state.

      - name: FSM0_STATE
        bits: 3..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: FSM 0 current state.


  - name: TIM_DBG3
    title: Timer Debug 3 Register
    address: 0x11800580000A8
    bus: RSL
    fields:
      - name: RINGS_PENDING_VEC
        bits: 63..0
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: |
          Pending rings vector. Indicates which ring in TIM are pending traversal. Bit 0 represents
          ring 0 while bit 63 represents ring 63.


  - name: TIM_FR_RN_CYCLES
    title: Free Running Cycle Count Register
    address: 0x11800580000C0
    bus: RSL
    attributes:
      dv_fc_scratch: "ALL"
    fields:
      - name: COUNT
        bits: 63..0
        access: R/W/H
        reset: --
        typical: --
        description: |
          Count of system coprocessor-clock cycles. This register is only writable when
          TIM_REG_FLAGS[ENA_TIM] = 0.


  - name: TIM_FR_RN_GPIOS
    title: Free Running GPIO Count Register
    address: 0x11800580000C8
    bus: RSL
    fields:
      - name: COUNT
        bits: 63..0
        access: R/W/H
        reset: --
        typical: --
        description: Count of GPIO cycles. This register is only writable when TIM_REG_FLAGS[ENA_TIM] = 0.


  - name: TIM_ENG(0..3)_ACTIVE
    title: Timer Engine Active Registers
    address: 0x1180058001000 + a*0x8
    bus: RSL
    fields:
      - name: --
        bits: 63..9
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: ACT
        bits: 8
        access: RO/H
        reset: --
        typical: --
        description: Engine active. For diagnostic use.

      - name: --
        bits: 7..6
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: RING_ID
        bits: 5..0
        access: RO/H
        reset: --
        typical: --
        description: Current ring ID. For diagnostic use.


  - name: TIM_RING(0..63)_CTL0
    title: Timer Ring 0-63 Control 0 Registers
    address: 0x1180058002000 + a*0x8
    bus: RSL
    fields:
      - name: EXPIRE_OFFSET
        bits: 63..32
        access: R/W/H
        reset: --
        typical: 0x0
        description: |
          Time at which the next bucket will be serviced, or offset. See also TIM_RING()_REL
          for the position relative to current time.

          If TIM_RING()_CTL1[ENA] = 0, then contains an offset. When ENA transitions from a
          zero to a one this offset will be added to the current time and loaded back into
          EXPIRE_OFFSET. Thus the offset sets the delta time between ENA transitioning to one and
          the very first time the ring will be serviced. Software should program different offsets
          on each ring to reduce congestion to prevent many rings from otherwise expiring
          concurrently.

          If TIM_RING()_CTL1[ENA] = 1, then contains the time the next bucket will be serviced.

          When EXPIRE_OFFSET reaches the current time (TIM_FR_RN_CYCLES or TIM_FR_RN_GPIOS),
          EXPIRE_OFFSET is set to the next expiration time (current time plus
          TIM_RING()_CTL0[INTERVAL]).
          EXPIRE_OFFSET is unpredictable after ENA_GPIO changes or TIM_RING()_CTL1[ENA]
          transitions from 1 to 0, and must be reprogrammed before (re-) setting
          TIM_RING()_CTL1[ENA].

      - name: INTERVAL
        bits: 31..0
        access: R/W
        reset: --
        typical: 0x0
        description: |
          Timer interval, measured in cycles or GPIO transitions.
          For every 64 entries in a bucket, the interval should be at least 1u. Minimal recommended
          value is 1u.


  - name: TIM_RING(0..63)_CTL1
    title: Timer Ring 0-63 Control 1 Registers
    address: 0x1180058002400 + a*0x8
    bus: RSL
    fields:
      - name: --
        bits: 63..51
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: RCF_BUSY
        bits: 50
        access: RO/H
        reset: 0
        typical: 0
        description: |
          Ring reconfiguration busy. When ENA is cleared, this bit will remain set until hardware
          completes the idling of the ring. ENA must not be re-enabled until clear.

      - name: INTC
        bits: 49..48
        access: R/W
        reset: --
        typical: 0x0
        description: |
          Interval count for error. Defines how many intervals could elapse from bucket expiration
          until actual bucket traversal before hardware asserts an error. Typical value is 0x0, 0x1,
          0x2.

      - name: ENA
        bits: 47
        access: R/W
        reset: --
        typical: 0
        attributes:
          regtest_force: "0"
        description: |
          Ring timer enable. After a 1 to 0 transition on ENA, the hardware still completes a bucket
          traversal for the ring if it were pending or active prior to the transition. When
          clearing, software must delay until TIM_RING()_REL[RING_ESR] = 0 to ensure the
          completion of the traversal before reprogramming the ring. When setting, RCF_BUSY must be
          clear.

      - name: ENA_GPIO
        bits: 46
        access: R/W
        reset: --
        typical: 0
        description: |
          When set, ring's timer tick is generated by the GPIO timer. The GPIO edge is defined by
          TIM_REG_FLAGS[GPIO_EDGE]. The default value (zero) means that timer ticks are generated
          from the internal timer. To change ENA_GPIO:

          1. TIM_RING()_CTL1[ENA] is cleared.

          2. [ENA_GPIO] is changed.

          3. TIM_RING()_CTL0[EXPIRE_OFFSET] is reprogrammed appropriately.

          4. TIM_RING()_CTL1[ENA] is set.

      - name: ENA_PRD
        bits: 45
        access: R/W
        reset: --
        typical: 0
        description: |
          Enable periodic mode, which disables the memory write of zeros to NUM_ENTRIES and
          CHUNK_REMAINDER when a bucket is traversed. In periodic mode ENA_DFB and ENA_LDWB must
          also be clear.

      - name: ENA_LDWB
        bits: 44
        access: R/W
        reset: --
        typical: 1
        description: When set, enables the use of Load and Don't-Write-Back when reading timer entry cache lines.

      - name: ENA_DFB
        bits: 43
        access: R/W
        reset: --
        typical: 0
        description: Enable don't free buffer. When set, chunk buffer is not released by the TIM back to FPA.

      - name: --
        bits: 42..40
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: BUCKET
        bits: 39..20
        access: R/W/H
        reset: --
        typical: 0x0
        description: |
          Current bucket. Should be set to 0x0 by software at enable time. Incremented once per
          bucket traversal.

      - name: BSIZE
        bits: 19..0
        access: R/W
        reset: --
        typical: 0x0
        description: Number of buckets minus one. If BSIZE = 0, there is only one bucket in the ring.


  - name: TIM_RING(0..63)_CTL2
    title: Timer Ring 0-63 Control 2 Registers
    address: 0x1180058002800 + a*0x8
    bus: RSL
    fields:
      - name: --
        bits: 63..53
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: CSIZE
        bits: 52..40
        access: R/W
        reset: --
        typical: 0x0
        description: Number of eight-byte words per chunk. CSIZE mod(16) should be zero.

      - name: --
        bits: 39..37
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: BASE
        bits: 36..0
        access: R/W
        reset: --
        typical: 0x0
        description: |
          Pointer<41:5> to bucket<0>.


  - name: TIM_RING(0..63)_AURA
    title: Timer Ring Aura Registers
    address: 0x1180058002C00 + a*0x8
    bus: RSL
    attributes:
      arch_max: "64"
    fields:
      - name: --
        bits: 63..16
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: AURA
        bits: 15..0
        access: R/W
        reset: --
        typical: --
        description: |
          Aura number used to free and return chucks to. Bits <15:12> must be zero.


  - name: TIM_RING(0..63)_REL
    title: Timer Ring 0-63 Relative Position Register
    address: 0x1180058003000 + a*0x8
    bus: RSL
    description: |
      Current positions of the TIM walker in both time and ring position, for easy synchronization
      with software.
    fields:
      - name: CUR_BUCKET
        bits: 63..44
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: Current bucket. Indicates the ring's current bucket. See TIM_RING()_CTL1[BUCKET].

      - name: --
        bits: 43..34
        access: RAZ
        reset: --
        typical: --
        description: Reserved.

      - name: RING_ESR
        bits: 33..32
        access: RO/H
        reset: 0x0
        typical: 0x0
        description: |
          Ring expiration status register. These registers hold the expiration status of the ring.
          0x0 = Ring has not expired.
          0x1 = Interval expired. Ring is queued to be traversed.
          0x2 = First interval expiration while ring is queued to be traversed.
          0x3 = Second interval expiration while ring is queued to be traversed.

          This field is zeroed when TIM_RING()_CTL1[ENA] transitions from 0 to 1.

      - name: TIMERCOUNT
        bits: 31..0
        access: RO/H
        reset: --
        typical: --
        description: |
          Timer count indicates how many timer ticks are left until the interval expiration,
          calculated as TIM_RING()_CTL0[EXPIRE_OFFSET] minus current time (TIM_FR_RN_CYCLES or
          TIM_FR_RN_GPIOS).

          Once ENA = 1, TIMERCOUNT will be observed to count down timer ticks. When TIMERCOUNT
          reaches 0x0, the ring's interval expired and the hardware forces a bucket traversal (and
          increments RING_ESR).

          Typical initialization value should be interval/constant; Cavium recommends that the
          constant be unique per ring. This creates an offset between the rings.
          TIMERCOUNT becomes and remains unpredictable whenever ENA = 0 or ENA_GPIO changes. It is
          software's responsibility to set TIMERCOUNT before TIM_RING()_CTL1[ENA] transitions
          from 0 -> 1.



